fitted_deaths = filter(fitted_data,var=="death")
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "grey")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "grey")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
gcases
library(patchwork)
gcases+gH+gD
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
gH = ggplot()+
geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "aquamarine")+
geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "aquamarine")+
geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "aquamarine")+
geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black")+
ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="aquamarine", lty=2)
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
gcases+gH+gD
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
gH = ggplot()+
geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "aquamarine")+
geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "aquamarine")+
geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "aquamarine")+
geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black")+
ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="aquamarine", lty=2)
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
gcases+gH+gD
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
g_cum_cases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=cumsum(lwr), ymax=cumsum(upr)), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=cumsvalue), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(report)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_cases)
g_cum_cases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=cumsum(lwr), ymax=cumsum(upr)), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(report)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_cases)
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(report)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_cases)
g_cum_deaths = ggplot()+
geom_point(data=deaths, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_cases)
g_cum_deaths = ggplot()+
geom_point(data=deaths, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_deaths)
deaths
fitted_cases
fitted_cases$value
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=cumsum(value)), col = "tan1")
g_cum_cases
head(fitted_cases)
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases[!is.na(value),],aes(x=as.Date(date), y=cumsum(value)), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases[!is.na(fitted_cases$value),],aes(x=as.Date(date), y=cumsum(value)), col = "tan1")
head(fitted_cases)
data=fitted_cases[!is.na(fitted_cases$value),]
data
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=fitted_cases[!is.na(fitted_cases$value),],aes(x=as.Date(date), y=cumsum(value)), col = "tan1")
g_cum_cases
head(fitted_cases)
fitted_data$var
cum_cases = filter(fitted_data,var=="cumRep")
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_deaths)
g_cum_cases
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
cum_cases = filter(fitted_data,var=="cumRep")
g_cum_cases = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cum_deaths)
g_cumRep = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumRep
observed_data
(gcases+gH)/(gD + g_cumRep)
cum_deaths = filter(fitted_data,var=="D")
cum_deaths
cum_deaths = cumsum(cum_deaths$value)
cum_deaths
cum_deaths = filter(fitted_data,var=="D")
cum_deaths = data.frame(date = cum_deaths$date, cumsum(cum_deaths$value))
cum_deathes
cum_deaths
cum_deaths = filter(observed_data,var=="D")
cum_deaths = data.frame(date = cum_deaths$date, cumsum(cum_deaths$value))
cum_deaths
cum_deaths = filter(observed_data,var=="D")
cum_deaths
observed_data
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, cumsum(cum_deaths$value))
cum_deaths
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=D), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumD
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=D), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumD
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumD
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")
g_cumD
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario[!is.na(D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumD
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario[!is.na(scenario$D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
(gcases+gH)/(gD + g_cumRep)
g_cumD
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('initial_model/fit.rds')
fitted_data = readRDS('initial_model/fitted_data.rds')
observed_data = readRDS('initial_model/observed_data.rds')
params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params = fix_pars(params)
# This gives me errors but then I run the line individually and it's fine
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))
end_date = max(observed_data$date)+14
#Changing from 90 to 15 improves fit substantially
start_date_offset = 15
start_date = min(observed_data$date) - start_date_offset
params_timevar = data.frame(
Date = c("2022-03-14"), # dates of breakpoints
Symbol = "beta0",                     # parameters to vary
Value = coef(fit, 'fitted')$time_params[2],                    # NA means calibrate to data
Type = "abs"                          # abs = change to value in Value col
)
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
gH = ggplot()+
geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "aquamarine")+
geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "aquamarine")+
geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "aquamarine")+
geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black")+
ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="aquamarine", lty=2)
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cum_cases = filter(fitted_data,var=="cumRep")
g_cumRep = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("cumulative cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario[!is.na(scenario$D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
gcases/gH/gD
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('initial_model/fit.rds')
fitted_data = readRDS('initial_model/fitted_data.rds')
observed_data = readRDS('initial_model/observed_data.rds')
params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params = fix_pars(params)
# This gives me errors but then I run the line individually and it's fine
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))
end_date = max(observed_data$date)+14
#Changing from 90 to 15 improves fit substantially
start_date_offset = 15
start_date = min(observed_data$date) - start_date_offset
params_timevar = data.frame(
Date = c("2022-03-14"), # dates of breakpoints
Symbol = "beta0",                     # parameters to vary
Value = coef(fit, 'fitted')$time_params[2],                    # NA means calibrate to data
Type = "abs"                          # abs = change to value in Value col
)
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
gH = ggplot()+
geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "aquamarine")+
geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "aquamarine")+
geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "aquamarine")+
geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black")+
ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="aquamarine", lty=2)
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cum_cases = filter(fitted_data,var=="cumRep")
g_cumRep = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("cumulative cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario[!is.na(scenario$D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('initial_model/fit.rds')
fitted_data = readRDS('initial_model/fitted_data.rds')
observed_data = readRDS('initial_model/observed_data.rds')
params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params = fix_pars(params)
# This gives me errors but then I run the line individually and it's fine
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))
end_date = max(observed_data$date)+14
#Changing from 90 to 15 improves fit substantially
start_date_offset = 15
start_date = min(observed_data$date) - start_date_offset
params_timevar = data.frame(
Date = c("2022-03-14"), # dates of breakpoints
Symbol = "beta0",                     # parameters to vary
Value = coef(fit, 'fitted')$time_params[2],                    # NA means calibrate to data
Type = "abs"                          # abs = change to value in Value col
)
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
cum_cases = filter(fitted_data,var=="cumRep")
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))
gH = ggplot()+
geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "aquamarine")+
geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "aquamarine")+
geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "aquamarine")+
geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black")+
ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="aquamarine", lty=2)
gD = ggplot()+
geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black")+
ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
gcases = ggplot()+
geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
geom_line(data=fitted_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black")+
ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
g_cumRep = ggplot()+
geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
ylab("cumulative cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
g_cumD = ggplot()+
geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
geom_line(data=scenario[!is.na(scenario$D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(lubridate)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('initial_model/fit.rds')
fitted_data = readRDS('initial_model/fitted_data.rds')
observed_data = readRDS('initial_model/observed_data.rds')
params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params = fix_pars(params)
# This gives me errors but then I run the line individually and it's fine
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))
end_date = max(observed_data$date)+14
#Changing from 90 to 15 improves fit substantially
start_date_offset = 15
start_date = min(observed_data$date) - start_date_offset
params_timevar = data.frame(
Date = c("2022-03-14"), # dates of breakpoints
Symbol = "beta0",                     # parameters to vary
Value = coef(fit, 'fitted')$time_params[2],                    # NA means calibrate to data
Type = "abs"                          # abs = change to value in Value col
)
state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
cum_cases = filter(fitted_data,var=="cumRep")
gcases+gH+gD
gcases
gH
gD
