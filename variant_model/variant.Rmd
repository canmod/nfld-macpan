---
title: "Modelling COVID-19 in Newfoundland and Labrador"
subtitle: Short-term forecasting
author: "Amy Hurford and Steve Walker"
date: "18/04/2022"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This fits a [compartmental epidemic model](https://mcmasterpandemic.shinyapps.io/mcmasterpandemicshiny/) to Newfoundland and Labrador COVID-19 data. This approach is used to model COVID-19 in [Ontario](https://mac-theobio.github.io/forecasts/outputs/McMasterOntarioForecastsBlog2022-01-26), however, there are differences in the model formulation for Newfoundland and Labrador.

The model is mechanistic, or process-based. This contrasts with pattern-based models, which aim to capture the shape of the data and have parameters that do not readily have epidemiological interpretations.

Some of the parameters in the process-based model that are fixed, i.e., general values that are constant across regions are:

```{r, warning=FALSE, message=FALSE, include=FALSE}
options(scipen=999)
devtools::source_gist("98cc4db25867bd18cc42b6568b4c6848", sha1 = "3cc333562e")
library(McMasterPandemic)
fit = readRDS('/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan/initial_model/initial_model_files/fit.rds')
params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))
params$delta = as.numeric(unname(coef(fit, 'fitted')$params[4]))
params$nonhosp_mort = as.numeric(unname(coef(fit, 'fitted')$params[5]))
```


Population size `r params["N"]`

Relative asymptomatic transmission (or contact) `r params["Ca"]`

Fraction of cases asymptomatic `r params["alpha"]`

Time in exposed class `r 1/as.numeric(params["sigma"])` days

Time in pre-symptomatic class `r 1/as.numeric(params["gamma_p"])` days

Time for asymptomatic recovery `r 1/as.numeric(params["gamma_a"])` days

Time for severely symptomatic transition to hospital/death `r 1/as.numeric(params["gamma_s"])` days

Time in hospital (acute care) `r 1/as.numeric(params["rho"])` days

Time in ICU to back to acute care `r 1/as.numeric(params["psi1"])`

Time in ICU to death `r 1/as.numeric(params["psi2"])`

Fraction of ICU cases dying `r as.numeric(params["phi2"])`

Time post-ICU to discharge `r 1/as.numeric(params["psi3"])`

Fraction of incidence reported as positive tests `r params["c_prop"]`

<!-- Average delay between incidence and test report `r params["c_delay_mean"]` days -->


The parameters in the process-based model that are titted the Newfoundland and Labrador hospitalization and death data, are:

Fraction of symptomatic cases that are mild: `r params$mu`

Fraction of hospitalized cases to acute care: `r params$phi1`

Fraction of acute care cases that are fatal: `r params$delta`

Probability of mortality without hospitalization: `r params$nonhosp_mort`

And the transmission rate, see [here](https://rpubs.com/ahurford/891932).

\

The software we used can be downloaded [here](https://github.com/mac-theobio/McMasterPandemic).

Further details will be added soon.


```{r, message = FALSE, warning=FALSE, include=FALSE}
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(lubridate)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan/variant_model/variant_model_files/fit_var.rds')
fitted_data = readRDS('/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan/variant_model/variant_model_files/fitted_data_var.rds')
observed_data = readRDS('/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan/initial_model/initial_model_files/observed_data2.rds')
```



```{r, include=FALSE}
cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
p = var.frac(fitted_cases$date)$var.frac
output = data.frame(date = fitted_cases$date, cases=fitted_cases$value, BA.2 = p*fitted_cases$value)

g.var = ggplot()+
  #geom_point(data=cases,aes(x= as.Date(date),y=value), col = "black", pch=21, fill = "white")+
geom_vline(aes(xintercept = tail(observed_data$date,1)),
                colour = "grey60", linetype = "dashed")+
geom_ribbon(data= output, aes(x= as.Date(date), ymax = cases,ymin=0),fill = "dodgerblue", alpha = 0.3)+
  geom_line(data= output, aes(x= as.Date(date), y = cases),col = "dodgerblue", alpha = 0.3)+
geom_ribbon(data= output, aes(x= as.Date(date), ymax = BA.2,ymin=0),fill = "blue", alpha = 0.3)+
  annotate("text", x = as.Date("2022-03-08"), y = 200, label = "BA.1", col = "dodgerblue")+
    annotate("text", x = as.Date("2022-03-28"), y = 100, label = "BA.2", col="darkblue")+
  ylab("Est. reported new cases (daily)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b", limits = c(as.Date("2021-12-15"), tail(as.Date(fitted_cases$date),1)))+
   geom_point(data = cases,aes(x = date, y = value),fill = "white", pch=21)+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")

```

```{r, include=FALSE}
observed_cases = filter(observed_data,var=="report")
gC=plot_forecast(fitted_data, "report", observed_data)+ylab("Est. reported new cases (daily)")+scale_x_date(date_breaks = "7 day", date_labels = "%d %b", limits = c(as.Date("2021-12-15"), tail(as.Date(fitted_cases$date),1)))
```


```{r, include=FALSE}
gH=plot_forecast(fitted_data, "H", observed_data)+ylab("Fitted hospital occupancy")+scale_x_date(date_breaks = "7 day", date_labels = "%d %b", limits = c(as.Date("2021-12-15"), tail(as.Date(fitted_cases$date),1)))+geom_vline(aes(xintercept = tail(observed_data$date,1)),colour = "grey60", linetype = "dashed")

```


```{r, include=FALSE}
library(lubridate)
deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")

g1 = ggplot()+
  geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.3, fill = "dodgerblue")+
  geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "dodgerblue")+ylab("Fitted deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b", limits = c(as.Date("2021-12-15"), tail(as.Date(fitted_cases$date),1)))+
  geom_point(data=deaths, aes(x=as.Date(week),y=value), fill = "white", pch=21)+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(aes(xintercept = tail(observed_data$date,1)), colour = "grey60", linetype = "dashed")

g1
```

```{r, fig.height=8, warning=FALSE, include=FALSE}
g.var/gH/g1
```
