---
title: "Counter-factual: no Alert level 4 on Jan 4, 2022"
author: "Steve Walker and Amy Hurford"
date: "12/04/2022"
output: 
  html_document: 
    keep_md: yes
---

Below I try to do a counter-factual simulation assuming no Alert level 4 on January 4, 2022

```{r, message = FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(McMasterPandemic)
library(ggplot2)
library(lubridate)
library(patchwork)
setwd("/Users/ahurford/Desktop/Work/Research/Research_Projects/2022/nfld-macpan")
source('get_data.R')
source('functions.R')
fit = readRDS('initial_model/fit.rds')
fitted_data = readRDS('initial_model/fitted_data.rds')
observed_data = readRDS('initial_model/observed_data.rds')

params = read_params("PHAC.csv")
params["N"] = 522453  # nfld population
params = fix_pars(params)

# This gives me errors but then I run the line individually and it's fine
params$beta0 = as.numeric(unname(coef(fit, 'fitted')$params[1]))
params$mu = as.numeric(unname(coef(fit, 'fitted')$params[2]))
params$phi1 = as.numeric(unname(coef(fit, 'fitted')$params[3]))

end_date = max(observed_data$date)
#Changing from 90 to 15 improves fit substantially
start_date_offset = 15
start_date = min(observed_data$date) - start_date_offset

# The breakpoint on Jan 4 is removed
params_timevar = data.frame(
  Date = c("2022-03-14"), # dates of breakpoints
  Symbol = "beta0",                     # parameters to vary
  Value = coef(fit, 'fitted')$time_params[2],                    # NA means calibrate to data
  Type = "abs"                          # abs = change to value in Value col
)


state <- make_state(params=params)
res1 <- run_sim(params=params,params_timevar=params_timevar,state=state, start_date=start_date, end_date=end_date)
scenario = data.frame(date=res1$date,H=res1$H, D = res1$death, report = res1$report, cumRep = res1$cumRep)
```
Getting the data ready for plotting
```{r}
hospitalizations = filter(observed_data,var=="H")
fitted_hosp = filter(fitted_data,var=="H")

deaths = filter(observed_data,var=="death")%>%group_by(week = cut(date, "week")) %>% summarise(value = sum(value))
fitted_deaths = filter(fitted_data,var=="death")
cum_deaths = filter(observed_data,var=="death")
cum_deaths = data.frame(date = cum_deaths$date, value=cumsum(cum_deaths$value))

cases = filter(observed_data,var=="report")
fitted_cases = filter(fitted_data,var=="report")
cum_cases = filter(fitted_data,var=="cumRep")
```

```{r,include=FALSE}
gH = ggplot()+
  geom_ribbon(data=fitted_hosp, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "mediumaquamarine")+
  geom_point(data=hospitalizations, aes(x=as.Date(date),y=value), col = "mediumaquamarine")+
  geom_line(data=fitted_hosp,aes(x=as.Date(date), y=value), col = "mediumaquamarine")+
  geom_line(data=scenario,aes(x=as.Date(date), y=H), col = "black",lty=1)+
  ylab("Hospital occupancy")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")



gD = ggplot()+
  geom_ribbon(data=fitted_deaths, aes(x=as.Date(date),ymin=7*lwr, ymax=7*upr), alpha = 0.5, fill = "plum3")+
  geom_point(data=deaths, aes(x=as.Date(week),y=value), col = "plum3")+
  geom_line(data=fitted_deaths,aes(x=as.Date(date), y=7*value), col = "plum3")+
  geom_line(data=scenario,aes(x=as.Date(date), y=7*D), col = "black", lty=1)+
  ylab("deaths (weekly)")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")



gcases = ggplot()+
  geom_ribbon(data=fitted_cases, aes(x=as.Date(date),ymin=lwr, ymax=upr), alpha = 0.5, fill = "tan1")+
  geom_point(data=cases, aes(x=as.Date(date),y=value), col = "tan1")+
  geom_line(data=fitted_cases,aes(x=as.Date(date), y=value), col = "tan1")+
  geom_line(data=scenario,aes(x=as.Date(date), y=report), col = "black",lty=1)+
  ylab("reported new cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")



g_cumRep = ggplot()+
  geom_point(data=cases, aes(x=as.Date(date),y=cumsum(value)), col = "tan1")+
  geom_line(data=cum_cases,aes(x=as.Date(date), y=value), col = "tan1")+
  geom_line(data=scenario,aes(x=as.Date(date), y=cumRep), col = "black")+
  ylab("cumulative cases")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)



g_cumD = ggplot()+
  geom_point(data=cum_deaths, aes(x=as.Date(date),y=value), col = "plum3")+
  geom_line(data=fitted_deaths[!is.na(fitted_deaths$value),],aes(x=as.Date(date), y=cumsum(value)), col = "plum3")+
  geom_line(data=scenario[!is.na(scenario$D),],aes(x=as.Date(date), y=cumsum(D)), col = "black")+
  ylab("cumulative deaths")+ scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")+xlab("")+geom_vline(xintercept = max(observed_data$date), col="grey", lty=2)
```

```{r, echo=F, warning=FALSE, fig.height=3}
gcases
gH
gD
```

**Figure 1. The effect of restrictions in early-January in Newfoundland and Labrador was to create a two-peaked wave 5 of prolonged duration that protected health care capacity.** Without the implementation of the Alert level 4 on January 4, 2022 (black lines), Newfoundland and Labrador would have experienced a wave 5 similar to other provinces: with a higher peak declining to low prevalence in mid-February.  The implementation of the Alert level 4, and the subsequent easing of restrictions, meant that Newfoundland and Labrador has experienced a two-peaked wave of longer duration. With the restrictions in early-January, the peak number of hospitalizations was reduced, protecting health care capacity. The total number of cases and deaths was only slightly reduced, suggesting that the predominant effect of the restrictions was to delay, rather than prevent, cases and severe illness.


```{r,echo=F, warning=FALSE, fig.height=3}
g_cumD + g_cumRep
```

**Figure 2. Despite creating a two-peaked wave, the final size for cases and deaths is only slightly reduced relative to the one-peaked wave had no Alert level 4 been implemented.** Steve are the `cumRep` values correct? Very different from observed data, but the fits are substantially overestimating cases and deaths too and this will get magnified for cumulative values.
